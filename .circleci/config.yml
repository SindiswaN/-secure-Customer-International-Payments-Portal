version: 2.1

orbs:
  node: circleci/node@5.0.3
  sonarcloud: sonarsource/sonarcloud@1.0.3

jobs:
  # ---------------- SECURITY CHECKS JOB ----------------
  security-checks:
    docker:
      - image: cimg/node:20.5
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
      - run:
          name: Install Dependencies
          command: npm install
      - run:
          name: Run ESLint (Code Quality)
          command: |
            npx eslint . --ext .js,.jsx,.mjs --ignore-path .gitignore || echo "ESLint completed"
      - run:
          name: Run Security Audit
          command: npm audit --audit-level=moderate || echo "Security audit completed"
      - run:
          name: Generate Test Coverage (if tests exist)
          command: |
            if [ -f "package.json" ] && grep -q "\"test\"" package.json; then
              npm test -- --coverage --watchAll=false || echo "Tests completed"
            else
              echo "No tests configured"
            fi

  # ---------------- SONARCLOUD SCAN JOB ----------------
  sonarcloud-scan:
    docker:
      - image: cimg/node:20.5
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
      - sonarcloud/scan

workflows:
  version: 2
  build_and_scan:
    jobs:
      - security-checks
      - sonarcloud-scan:
          requires:
            - security-checks
          context: sonarcloud